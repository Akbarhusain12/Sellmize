<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profit Analyzer - SellMize AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            colors: {
              brand: {
                50: "#eef2ff",
                100: "#e0e7ff",
                200: "#c7d2fe",
                300: "#a5b4fc",
                400: "#818cf8",
                500: "#6366f1", // Indigo Primary
                600: "#4f46e5",
                700: "#4338ca",
                800: "#3730a3",
                900: "#312e81",
              },
              slate: {
                850: "#1e293b",
              },
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      /* --- Animations --- */
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideUpFade {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* --- Flash Messages --- */
      #flash-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-end;
        pointer-events: none;
      }
      .flash {
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.9rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        animation: slideInRight 0.3s ease-out;
        pointer-events: auto;
        border-left: 4px solid;
        background: white;
      }
      .flash.error {
        border-color: #ef4444;
        color: #991b1b;
      }
      .flash.success {
        border-color: #10b981;
        color: #065f46;
      }
      .flash.info {
        border-color: #3b82f6;
        color: #1e40af;
      }
      .flash.fade-out {
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s;
      }

      /* --- Nav & Tabs --- */
      .nav-item {
        position: relative;
        color: #64748b;
        font-weight: 500;
        transition: color 0.2s;
      }
      .nav-item:hover,
      .nav-item.active {
        color: #4f46e5;
      }
      .nav-item::after {
        content: "";
        position: absolute;
        bottom: -24px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #4f46e5;
        transform: scaleX(0);
        transition: transform 0.2s;
      }
      .nav-item.active::after {
        transform: scaleX(1);
      }

      .tab-container {
        background-color: #f1f5f9;
        padding: 0.375rem;
        border-radius: 0.75rem;
        display: flex;
        overflow-x: auto;
      }
      .tab-button {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 0.5rem;
        color: #64748b;
        transition: all 0.2s ease-in-out;
        white-space: nowrap;
      }
      .tab-button:hover {
        color: #334155;
      }
      .tab-button.active {
        background-color: white;
        color: #4f46e5;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      }

      /* --- File Input --- */
      input[type="file"]::file-selector-button {
        background-color: #f8fafc;
        color: #475569;
        border: 1px solid #e2e8f0;
        padding: 0.3rem 0.8rem;
        border-radius: 0.375rem;
        margin-right: 1rem;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
      }
      input[type="file"]::file-selector-button:hover {
        background-color: #f1f5f9;
      }

      /* --- Loading --- */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* --- Helper for tooltips (New Logic Feature) --- */
      .info-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: #e0e7ff;
        color: #4f46e5;
        border-radius: 50%;
        font-size: 10px;
        font-weight: bold;
        cursor: help;
        margin-left: 6px;
        position: relative;
      }
      .info-icon:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 11px;
        white-space: nowrap;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>

  <body class="bg-slate-50 min-h-screen flex flex-col text-slate-900">
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
      <nav
        class="container mx-auto px-4 sm:px-6 h-16 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-sm"
          >
            <svg
              class="w-5 h-5 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              ></path>
            </svg>
          </div>
          <span class="text-xl font-bold text-slate-900 tracking-tight"
            >SellMize AI</span
          >
        </div>

        <div class="hidden md:flex items-center space-x-8">
          <a href="/" class="nav-item">Dashboard</a>
          <a
            href="/analyzer"
            class="text-brand-600 font-medium transition-colors"
            >Profit Analyzer</a
          >
          <a href="/strategist" class="nav-item">Strategist</a>
          <a href="/mize" class="nav-item">Mize</a>
        </div>
        <div class="flex items-center gap-4">
          {% if current_user.is_authenticated %}
          <div class="hidden sm:flex flex-col items-end mr-2">
            <span class="text-sm font-semibold text-slate-700"
              >{{ current_user.name or current_user.email }}</span
            >
            <a
              href="{{ url_for('auth.logout') }}"
              class="text-xs text-red-500 hover:text-red-700 font-medium transition-colors"
              >Sign out</a
            >
          </div>
          <div
            class="w-9 h-9 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-bold text-sm border border-brand-200 cursor-default"
          >
            {{ current_user.email[0].upper() }}
          </div>
          {% else %}
          <a
            href="{{ url_for('auth.login') }}"
            class="text-sm font-medium text-slate-600 hover:text-brand-600"
            >Log in</a
          >
          <a
            href="{{ url_for('auth.register') }}"
            class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg shadow-sm"
            >Get Started</a
          >
          {% endif %}
        </div>
      </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-8 flex-grow relative">
      <div class="max-w-6xl mx-auto">
        <div
          id="uploadSection"
          class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-8"
        >
          <div class="mb-6 border-b border-slate-100 pb-4">
            <h1 class="text-2xl font-bold text-slate-900">
              E-commerce Profit Analyzer
            </h1>
            <p class="text-slate-500 mt-1 text-sm">
              Upload your Amazon reports to generate a consolidated P&L report.
            </p>
          </div>

          <form
            id="uploadForm"
            action="/analyze"
            method="POST"
            enctype="multipart/form-data"
            class="space-y-6"
          >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  for="order_files"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Order Files
                  <span
                    class="info-icon"
                    data-tooltip="Your Amazon All Orders report"
                    >?</span
                  ></label
                >
                <input
                  type="file"
                  name="order_files"
                  id="order_files"
                  multiple
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
                <p
                  id="order_files_status"
                  class="text-xs text-emerald-600 mt-1 font-medium"
                ></p>
              </div>
              <div>
                <label
                  for="payment_files"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Payment Files
                  <span
                    class="info-icon"
                    data-tooltip="Settlement reports from Amazon"
                    >?</span
                  ></label
                >
                <input
                  type="file"
                  name="payment_files"
                  id="payment_files"
                  multiple
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
                <p
                  id="payment_files_status"
                  class="text-xs text-emerald-600 mt-1 font-medium"
                ></p>
              </div>
              <div>
                <label
                  for="return_files"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Return Files
                  <span
                    class="info-icon"
                    data-tooltip="Customer returns and refunds"
                    >?</span
                  ></label
                >
                <input
                  type="file"
                  name="return_files"
                  id="return_files"
                  multiple
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
                <p
                  id="return_files_status"
                  class="text-xs text-emerald-600 mt-1 font-medium"
                ></p>
              </div>
              <div>
                <label
                  for="cost_price_file"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Cost Price File
                  <span
                    class="info-icon"
                    data-tooltip="Excel file with SKU and cost per unit"
                    >?</span
                  ></label
                >
                <input
                  type="file"
                  name="cost_price_file"
                  id="cost_price_file"
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
                <p
                  id="cost_price_file_status"
                  class="text-xs text-emerald-600 mt-1 font-medium"
                ></p>
              </div>
            </div>

            <div class="pt-6 border-t border-slate-200">
              <div class="flex items-center mb-4">
                <div class="p-1.5 bg-brand-100 rounded-md mr-2">
                  <svg
                    class="w-4 h-4 text-brand-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7V3m8 4V3m-9 8h10m-11 8h12a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                    ></path>
                  </svg>
                </div>
                <h3
                  class="text-sm font-semibold text-slate-900 uppercase tracking-wide"
                >
                  Date Range Filter
                </h3>
              </div>
              <div
                class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 p-5 rounded-lg border border-slate-200"
              >
                <div>
                  <label
                    for="start_date"
                    class="block text-xs font-medium text-slate-500 mb-1"
                    >Start Date</label
                  >
                  <input
                    type="date"
                    id="start_date"
                    name="start_date"
                    class="block w-full rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="end_date"
                    class="block text-xs font-medium text-slate-500 mb-1"
                    >End Date</label
                  >
                  <input
                    type="date"
                    id="end_date"
                    name="end_date"
                    class="block w-full rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm"
                  />
                </div>
              </div>
              <p class="text-xs text-slate-400 mt-2 italic">
                * Leave blank to analyze all data.
              </p>
            </div>

            <div class="pt-4 border-t border-slate-200">
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-semibold text-slate-900 uppercase tracking-wide"
                >
                  Business Expenses
                  <span
                    class="info-icon"
                    data-tooltip="Add all your monthly costs (ads, rent, salaries, etc.)"
                    >?</span
                  >
                </h3>
                <button
                  type="button"
                  id="addExpenseBtn"
                  class="text-xs font-medium text-brand-600 hover:text-brand-800 bg-brand-50 px-3 py-1.5 rounded-md transition-colors"
                >
                  + Add Expense
                </button>
              </div>
              <div id="expenseContainer" class="space-y-3"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
              <button
                type="button"
                id="analyzeBtn"
                class="flex justify-center items-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-colors"
              >
                <span id="analyzeText"> Analyze</span>
                <span
                  id="analyzeLoader"
                  class="loading ml-2"
                  style="display: none"
                ></span>
              </button>
              <button
                type="button"
                id="downloadBtn"
                disabled
                class="flex justify-center items-center py-2.5 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <span id="downloadText">ðŸ“¥ Download Full Report</span>
                <span
                  id="downloadLoader"
                  class="loading ml-2 border-slate-400 border-t-slate-700"
                  style="display: none"
                ></span>
              </button>
            </div>
          </form>
        </div>

        <div
          id="summarySection"
          class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-8"
          style="display: none"
        >
          <h2 class="text-xl font-bold text-slate-900 mb-6">
            Profit Analysis Summary
          </h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            <div class="lg:col-span-2">
              <div
                id="metricsGrid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"
              >
                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-bold text-emerald-600 uppercase">
                    Total Revenue
                  </p>
                  <p
                    class="text-2xl font-bold text-emerald-700 mt-1"
                    id="totalRevenue"
                  >
                    -
                  </p>
                </div>

                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-bold text-blue-600 uppercase">
                    Money Received
                  </p>
                  <p
                    class="text-2xl font-bold text-blue-700 mt-1"
                    id="totalPaymentReceived"
                  >
                    -
                  </p>
                </div>

                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-bold text-amber-600 uppercase">
                    Money Pending
                  </p>
                  <p
                    class="text-2xl font-bold text-amber-700 mt-1"
                    id="totalPendingPayment"
                  >
                    -
                  </p>
                </div>

                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Total Qty
                  </p>
                  <p
                    class="text-2xl font-bold text-slate-900 mt-1"
                    id="totalQuantity"
                  >
                    -
                  </p>
                </div>

                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Returned
                  </p>
                  <p
                    class="text-2xl font-bold text-red-600 mt-1"
                    id="totalReturned"
                  >
                    -
                  </p>
                </div>

                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Unpaid Units
                  </p>
                  <p
                    class="text-2xl font-bold text-amber-600 mt-1"
                    id="totalUnpaidQuantity"
                  >
                    -
                  </p>
                </div>

                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Product Costs
                  </p>
                  <p
                    class="text-2xl font-bold text-slate-700 mt-1"
                    id="totalCost"
                  >
                    -
                  </p>
                </div>

                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Amazon Fees
                  </p>
                  <p
                    class="text-2xl font-bold text-slate-700 mt-1"
                    id="totalAmzFees"
                  >
                    -
                  </p>
                </div>
              </div>

              <div
                id="dynamicExpenseCards"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
              ></div>
            </div>

            <div class="lg:col-span-1 h-full">
              <div
                id="netProfitContainer"
                class="bg-slate-50 p-6 rounded-xl border border-slate-200 h-full flex flex-col justify-center items-center text-center"
              >
                <p
                  id="netProfitTitle"
                  class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-2"
                >
                  Net Profit
                </p>
                <p
                  class="text-4xl font-extrabold text-slate-900"
                  id="netProfit"
                >
                  -
                </p>
                <p class="text-xs text-slate-400 font-medium mt-2">
                  After all costs & expenses
                </p>
              </div>
            </div>
          </div>
        </div>

        <div
          id="tabSection"
          class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-8"
          style="display: none"
        >
          <div class="tab-container mb-6">
            <button id="ordersTab" class="tab-button active">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                ></path>
              </svg>
              Best Sellers
            </button>
            <button id="statesTab" class="tab-button">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Top States
            </button>
            <button id="returnsTab" class="tab-button">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
                ></path>
              </svg>
              Returns
            </button>
            <button id="unpaidTab" class="tab-button">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Unpaid Orders
            </button>
          </div>

          <div id="ordersContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center">
              Your Top 10 Best-Selling Products
            </h3>
            <div class="overflow-x-auto rounded-lg border border-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Rank
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Product (SKU)
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Units Sold
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="top10TableBody"
                  class="bg-white divide-y divide-slate-200"
                ></tbody>
              </table>
            </div>
          </div>

          <div id="statesContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
              Where Your Customers Are
            </h3>
            <div class="p-4 border border-slate-200 rounded-lg">
              <canvas id="stateOrdersChart" height="100"></canvas>
            </div>
          </div>

          <div id="returnsContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
              Most Returned Products
            </h3>
            <div class="overflow-x-auto rounded-lg border border-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Rank
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Product (SKU)
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Returns
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Reason
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="top10ReturnsTableBody"
                  class="bg-white divide-y divide-slate-200"
                ></tbody>
              </table>
            </div>
          </div>

          <div id="unpaidContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
              Orders Waiting for Payment
            </h3>
            <div class="overflow-x-auto rounded-lg border border-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Order ID
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Product
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Units
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Value
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Order Date
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Location
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="unpaidTableBody"
                  class="bg-white divide-y divide-slate-200"
                ></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <a
      href="/strategist"
      id="strategistNotification"
      class="hidden fixed bottom-6 right-6 z-50 bg-white border border-brand-100 p-4 rounded-xl shadow-2xl flex items-center gap-4 cursor-pointer transition-all hover:scale-105 hover:shadow-brand-500/20 group"
      style="animation: slideUpFade 0.5s ease-out forwards"
    >
      <div
        class="relative w-12 h-12 bg-brand-50 rounded-full flex items-center justify-center text-brand-600"
      >
        <i class="text-2xl not-italic">âš¡</i>
        <span
          class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full animate-ping opacity-75"
        ></span>
        <span
          class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"
        ></span>
      </div>
      <div>
        <p
          class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
        >
          Analysis Complete
        </p>
        <p
          class="font-bold text-slate-800 text-sm group-hover:text-brand-600 transition-colors"
        >
          Generate Strategy â†’
        </p>
      </div>
    </a>

    <footer class="bg-white border-t border-slate-200 pt-16 pb-8">
      <div class="container mx-auto px-4 sm:px-6">
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 mb-12"
        >
          <div>
            <div class="flex items-center gap-2 mb-4">
              <div
                class="w-6 h-6 bg-brand-600 rounded flex items-center justify-center"
              >
                <svg
                  class="w-4 h-4 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  ></path>
                </svg>
              </div>
              <span class="text-lg font-bold text-slate-900">SellMize AI</span>
            </div>
            <p class="text-slate-500 text-sm leading-relaxed mb-6">
              Empowering e-commerce sellers with data-driven insights,
              automation, and intelligent growth tools.
            </p>
            <div class="flex space-x-4">
              <a
                href="#"
                class="text-slate-400 hover:text-brand-600 transition-colors"
              >
                <span class="sr-only">Twitter</span>
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"
                  />
                </svg>
              </a>
              <a
                href="#"
                class="text-slate-400 hover:text-brand-600 transition-colors"
              >
                <span class="sr-only">GitHub</span>
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    fill-rule="evenodd"
                    d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                    clip-rule="evenodd"
                  />
                </svg>
              </a>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-slate-900 mb-4">Product</h4>
            <ul class="space-y-3 text-sm text-slate-500">
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Features</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Integrations</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Pricing</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Changelog</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h4 class="font-semibold text-slate-900 mb-4">Resources</h4>
            <ul class="space-y-3 text-sm text-slate-500">
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Documentation</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >API Reference</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Community</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Help Center</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h4 class="font-semibold text-slate-900 mb-4">Company</h4>
            <ul class="space-y-3 text-sm text-slate-500">
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >About Us</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Careers</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Privacy Policy</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-brand-600 transition-colors"
                  >Terms of Service</a
                >
              </li>
            </ul>
          </div>
        </div>

        <div
          class="border-t border-slate-100 pt-8 flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <p class="text-slate-400 text-sm">
            Â© 2025 SellMize AI Inc. All rights reserved.
          </p>
        </div>
      </div>
    </footer>

    <div id="flash-container"></div>

    <script>
      flatpickr("#start_date", { dateFormat: "Y-m-d", theme: "light", maxDate: "today" });
      flatpickr("#end_date", { dateFormat: "Y-m-d", theme: "light", maxDate: "today" });

      document.addEventListener("DOMContentLoaded", function () {
          let currentFileName = null;
          let stateOrdersChart = null;
          const analyzeBtn = document.getElementById("analyzeBtn");
          const downloadBtn = document.getElementById("downloadBtn");
          const tabs = ['orders', 'returns', 'states', 'unpaid'];

          // File Upload Feedback
          const fileInputs = document.querySelectorAll('input[type="file"]');
          fileInputs.forEach(input => {
              input.addEventListener('change', (e) => {
                  const count = e.target.files.length;
                  const statusId = input.id + '_status';
                  const statusEl = document.getElementById(statusId);
                  if (count > 0) {
                      statusEl.innerHTML = `âœ… ${count} file(s) selected`;
                      showFlash(`Selected ${count} files`, 'info');
                  } else {
                      statusEl.innerHTML = '';
                  }
              });
          });

          function showFlash(message, category) {
              const flashDiv = document.createElement("div");
              flashDiv.className = `flash ${category}`;
              flashDiv.innerHTML = `<span>${message}</span>`;
              document.getElementById("flash-container").appendChild(flashDiv);
              setTimeout(() => {
                  flashDiv.classList.add("fade-out");
                  setTimeout(() => flashDiv.remove(), 300);
              }, 4000);
          }

          function formatCurrency(value) {
              return "â‚¹" + parseFloat(value).toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          }
          function formatNumber(value) { return parseFloat(value).toLocaleString("en-IN"); }

          function switchTabs(selectedTab) {
              tabs.forEach(tab => {
                  document.getElementById(tab + 'Tab').classList.remove("active");
                  document.getElementById(tab + 'Content').style.display = "none";
              });
              document.getElementById(selectedTab + 'Tab').classList.add("active");
              document.getElementById(selectedTab + 'Content').style.display = "block";
          }

          // Dynamic Expenses
          const expenseContainer = document.getElementById("expenseContainer");
          const addExpenseBtn = document.getElementById("addExpenseBtn");
          let expenseCount = 0;

          function addExpenseRow(name = "", amount = "") {
              expenseCount++;
              const row = document.createElement("div");
              row.className = "grid grid-cols-2 gap-3 items-center";
              row.innerHTML = `
                  <input type="text" name="expense_name_${expenseCount}" placeholder="e.g. Facebook Ads" value="${name}" required
                      class="rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm p-2 border">
                  <div class="flex items-center gap-2">
                      <input type="number" name="expense_amount_${expenseCount}" placeholder="Amount in â‚¹" value="${amount}" step="0.01" required
                          class="flex-1 rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm p-2 border">
                      <button type="button" class="remove-expense w-9 h-9 flex items-center justify-center rounded-lg text-red-500 hover:bg-red-50 font-bold text-xl transition-colors">Ã—</button>
                  </div>`;
              expenseContainer.appendChild(row);
              row.querySelector(".remove-expense").addEventListener("click", () => row.remove());
          }
          addExpenseRow();
          addExpenseBtn.addEventListener("click", () => addExpenseRow());

          downloadBtn.addEventListener("click", handleDownloadClick);
          tabs.forEach(tab => document.getElementById(tab + 'Tab').addEventListener("click", () => switchTabs(tab)));
          analyzeBtn.addEventListener("click", handleAnalyzeClick);

          async function handleAnalyzeClick() {
              const form = document.getElementById("uploadForm");
              const formData = new FormData(form);

              const rows = document.querySelectorAll("#expenseContainer div.grid");
              rows.forEach((row) => {
                  const nameInput = row.querySelector(`input[name^='expense_name_']`);
                  const amountInput = row.querySelector(`input[name^='expense_amount_']`);
                  const expenseName = nameInput.value.trim().toLowerCase().replace(/\s+/g, "_");
                  const expenseAmount = amountInput.value;
                  formData.delete(nameInput.name);
                  formData.delete(amountInput.name);
                  if (expenseName && expenseAmount) formData.append(`expense_${expenseName}`, expenseAmount);
              });

              document.getElementById("analyzeText").textContent = "Analyzing...";
              document.getElementById("analyzeLoader").style.display = "inline-block";
              analyzeBtn.disabled = true;

              try {
                  const response = await fetch("/analyze", { method: "POST", body: formData });
                  const raw = await response.text();

                  let result;
                  try { result = JSON.parse(raw); }
                  catch (e) { showFlash("Server Error: Check Console", "error"); return; }

                  if (result.success) {
                      currentFileName = result.filename;

                      // Chart
                      if (result.top_states && result.top_states.length > 0) {
                          const ctx = document.getElementById("stateOrdersChart").getContext("2d");
                          if (stateOrdersChart) stateOrdersChart.destroy();
                          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                          gradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
                          gradient.addColorStop(1, 'rgba(79, 70, 229, 0.7)');

                          stateOrdersChart = new Chart(ctx, {
                              type: "bar",
                              data: {
                                  labels: result.top_states.map(s => s.state),
                                  datasets: [{
                                      label: "Orders",
                                      data: result.top_states.map(s => s.total_orders),
                                      backgroundColor: gradient,
                                      borderRadius: 6,
                                      barThickness: 35
                                  }]
                              },
                              options: {
                                  responsive: true,
                                  maintainAspectRatio: false,
                                  plugins: { legend: { display: false } },
                                  scales: {
                                      x: { grid: { display: false }, ticks: { color: "#64748b", font: { weight: '600' } } },
                                      y: { border: { display: false }, grid: { color: "#f1f5f9" }, ticks: { color: "#64748b", font: { weight: '600' } } }
                                  }
                              }
                          });
                      }

                      // Populate Data - UPDATED METRICS to match New Functionality
                      document.getElementById("totalRevenue").textContent = formatCurrency(result.summary.total_revenue || 0);
                      document.getElementById("totalPaymentReceived").textContent = formatCurrency(result.summary.total_payment_received || 0);
                      document.getElementById("totalPendingPayment").textContent = formatCurrency(result.summary.total_pending_payment || 0);
                      document.getElementById("totalQuantity").textContent = formatNumber(result.summary.total_quantity || 0);
                      document.getElementById("totalReturned").textContent = formatNumber(result.summary.total_return_quantity || 0);
                      document.getElementById("totalUnpaidQuantity").textContent = formatNumber(result.summary.total_unpaid_quantity || 0);
                      document.getElementById("totalCost").textContent = formatCurrency(result.summary.total_cost || 0);
                      document.getElementById("totalAmzFees").textContent = formatCurrency(result.summary.total_amz_fees || 0);

                      const netProfit = result.summary.net_profit || 0;
                      const profitText = document.getElementById("netProfit");
                      const profitContainer = document.getElementById("netProfitContainer");
                      profitText.textContent = formatCurrency(netProfit);

                      if (netProfit < 0) {
                          profitContainer.className = "bg-red-50 p-6 rounded-xl border border-red-200 h-full flex flex-col justify-center items-center text-center";
                          profitText.className = "text-4xl font-extrabold text-red-600";
                      } else {
                          profitContainer.className = "bg-emerald-50 p-6 rounded-xl border border-emerald-200 h-full flex flex-col justify-center items-center text-center";
                          profitText.className = "text-4xl font-extrabold text-emerald-600";
                      }

                      // Dynamic Expense Cards
                      const cardsContainer = document.getElementById("dynamicExpenseCards");
                      document.querySelectorAll(".dynamic-expense-card").forEach(c => c.remove());

                      Object.keys(result.summary).forEach(key => {
                          if (key.startsWith("expense_")) {
                              const label = key.replace("expense_", "").replace(/_/g, " ");
                              const card = document.createElement("div");
                              card.className = "dynamic-expense-card bg-white p-4 rounded-lg border border-slate-200 shadow-sm";
                              card.innerHTML = `
                                  <p class="text-xs font-medium text-slate-500 uppercase">${label}</p>
                                  <p class="text-2xl font-bold text-slate-900 mt-1">${formatCurrency(result.summary[key])}</p>
                              `;
                              cardsContainer.appendChild(card);
                          }
                      });

                      // Tables
                      populateTable("top10TableBody", result.top_10_skus, [], 'orders');
                      populateTable("top10ReturnsTableBody", result.top_10_returns, [], 'returns');
                      populateTable("unpaidTableBody", result.unpaid_orders, [], 'unpaid');

                      // Show Results
                      document.getElementById("summarySection").style.display = "block";
                      document.getElementById("tabSection").style.display = "block";
                      switchTabs("orders");
                      downloadBtn.disabled = false;
                      showFlash("âœ… Analysis complete!", "success");
                      document.getElementById("summarySection").scrollIntoView({ behavior: "smooth" });

                      document.getElementById('strategistNotification').classList.remove('hidden');

                  } else {
                      showFlash("Error: " + result.error, "error");
                  }
              } catch (error) {
                  showFlash("Error: " + error.message, "error");
              } finally {
                  document.getElementById("analyzeText").textContent = "ðŸš€ Analyze My Business";
                  document.getElementById("analyzeLoader").style.display = "none";
                  analyzeBtn.disabled = false;
              }
          }

          function populateTable(elementId, data, columns, type) {
              const tbody = document.getElementById(elementId);
              tbody.innerHTML = "";
              if (!data || data.length === 0) return;
              data.forEach(item => {
                  const tr = document.createElement("tr");
                  tr.className = "hover:bg-slate-50 transition-colors";
                  if (type === 'orders') {
                       tr.innerHTML = `
                           <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-600">${item.Rank}</td>
                           <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-medium">${item.sku}</td>
                           <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-900">${formatNumber(item.quantity)}</td>
                       `;
                  } else if (type === 'returns') {
                      let category = item.return_category || item.category || 'N/A';
                      if(String(category).toLowerCase() === 'nan' || !category) category = 'General Return';
                      tr.innerHTML = `
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">${item.Rank}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-medium">${item.sku}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-900">${formatNumber(item.quantity)}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-xs"><span class="px-3 py-1 bg-red-100 text-red-700 rounded-full font-semibold">${category}</span></td>
                      `;
                  } else if (type === 'unpaid') {
                      const pendingRevenue = item['Pending Revenue'] || (item['Quantity'] * item['Item Price']);
                      tr.innerHTML = `
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-medium">${item['Order ID']}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${item.SKU}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${item.Quantity}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-amber-700">${formatCurrency(pendingRevenue)}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item['Order Date'] || '-'}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item['Ship State'] || '-'}</td>
                      `;
                  }
                  tbody.appendChild(tr);
              });
          }

          async function handleDownloadClick() {
              if (!currentFileName) return;
              document.getElementById("downloadText").textContent = "Downloading...";
              document.getElementById("downloadLoader").style.display = "inline-block";
              downloadBtn.disabled = true;
              try {
                  const response = await fetch("/download/" + currentFileName);
                  if (response.ok) {
                      const blob = await response.blob();
                      const url = window.URL.createObjectURL(blob);
                      const a = document.createElement("a");
                      a.href = url; a.download = currentFileName;
                      document.body.appendChild(a); a.click();
                      window.URL.revokeObjectURL(url); document.body.removeChild(a);
                      showFlash("âœ… Report downloaded!", "success");
                  }
              } catch(e) { showFlash("Download failed", "error"); }
              finally {
                 document.getElementById("downloadText").textContent = "ðŸ“¥ Download Full Report";
                 document.getElementById("downloadLoader").style.display = "none";
                 downloadBtn.disabled = false;
              }
          }

          // Session Restore
          const isReload = performance.getEntriesByType("navigation")[0]?.type === "reload";
          const savedDataExists = {{ 'true' if data_exists else 'false' }};

          if (isReload) {
              if(document.getElementById("uploadSection")) document.getElementById("uploadSection").style.display = "block";
              fetch('/reset_analysis');
          } else if (savedDataExists) {
              try {
                  const savedSummary = {{ summary | tojson | safe }};
                  if(document.getElementById("uploadSection")) document.getElementById("uploadSection").style.display = "none";
                  const savedExpenses = {{ expenses | tojson | safe }};
                  if (savedExpenses) {
                      expenseContainer.innerHTML = "";
                      Object.entries(savedExpenses).forEach(([k,v]) => addExpenseRow(k, v));
                  }
                  const mockResult = {
                      success: true, summary: savedSummary,
                      top_states: {{ top_states | tojson | safe }},
                      top_10_skus: {{ top_10_skus | tojson | safe }},
                      top_10_returns: {{ top_10_returns | tojson | safe }},
                      unpaid_orders: {{ unpaid_orders | tojson | safe }}
                  };

                  if (mockResult.top_states) {
                      const ctx = document.getElementById("stateOrdersChart").getContext("2d");
                      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                      gradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
                      gradient.addColorStop(1, 'rgba(79, 70, 229, 0.7)');
                      stateOrdersChart = new Chart(ctx, {
                          type: "bar",
                          data: {
                              labels: mockResult.top_states.map(s => s.state),
                              datasets: [{ label: "Orders", data: mockResult.top_states.map(s => s.total_orders), backgroundColor: gradient, borderRadius: 6, barThickness: 35 }]
                          },
                          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: {grid:{display:false}}, y: {border:{display:false}} } }
                      });
                  }

                  document.getElementById("totalRevenue").textContent = formatCurrency(mockResult.summary.total_revenue || 0);
                  document.getElementById("totalPaymentReceived").textContent = formatCurrency(mockResult.summary.total_payment_received || 0);
                  document.getElementById("totalPendingPayment").textContent = formatCurrency(mockResult.summary.total_pending_payment || 0);
                  document.getElementById("totalQuantity").textContent = formatNumber(mockResult.summary.total_quantity || 0);
                  document.getElementById("totalReturned").textContent = formatNumber(mockResult.summary.total_return_quantity || 0);
                  document.getElementById("totalUnpaidQuantity").textContent = formatNumber(mockResult.summary.total_unpaid_quantity || 0);
                  document.getElementById("totalCost").textContent = formatCurrency(mockResult.summary.total_cost || 0);
                  document.getElementById("totalAmzFees").textContent = formatCurrency(mockResult.summary.total_amz_fees || 0);
                  document.getElementById("netProfit").textContent = formatCurrency(mockResult.summary.net_profit || 0);

                  populateTable("top10TableBody", mockResult.top_10_skus, [], 'orders');
                  populateTable("top10ReturnsTableBody", mockResult.top_10_returns, [], 'returns');
                  populateTable("unpaidTableBody", mockResult.unpaid_orders, [], 'unpaid');

                  document.getElementById("summarySection").style.display = "block";
                  document.getElementById("tabSection").style.display = "block";
                  switchTabs("orders");
                  downloadBtn.disabled = false;
                  currentFileName = "{{ session.get('output_filename', '') }}";

                  document.getElementById('strategistNotification').classList.remove('hidden');

              } catch(e) { console.error("Restore failed", e); }
          }
      });
    </script>
  </body>
</html>
