<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profit Analyzer - SellMize AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            colors: {
              brand: {
                50: "#eef2ff",
                100: "#e0e7ff",
                200: "#c7d2fe",
                300: "#a5b4fc",
                400: "#818cf8",
                500: "#6366f1", // Indigo Primary
                600: "#4f46e5",
                700: "#4338ca",
                800: "#3730a3",
                900: "#312e81",
              },
              slate: {
                850: "#1e293b",
              },
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      /* Smooth Flash Messages */
      #flash-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-end;
        pointer-events: none;
      }
      .flash {
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.9rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        animation: slideInRight 0.3s ease-out;
        pointer-events: auto;
        border-left: 4px solid;
        background: white;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .flash.error {
        border-color: #ef4444;
        color: #991b1b;
      }
      .flash.success {
        border-color: #10b981;
        color: #065f46;
      }
      .flash.info {
        border-color: #3b82f6;
        color: #1e40af;
      }
      .flash.fade-out {
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s;
      }

      /* Nav Styling */
      .nav-item {
        position: relative;
        color: #64748b;
        font-weight: 500;
        transition: color 0.2s;
      }
      .nav-item:hover,
      .nav-item.active {
        color: #4f46e5;
      }
      .nav-item::after {
        content: "";
        position: absolute;
        bottom: -24px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #4f46e5;
        transform: scaleX(0);
        transition: transform 0.2s;
      }
      .nav-item.active::after {
        transform: scaleX(1);
      }

      /* Segmented Tab Control Styling */
      .tab-container {
        background-color: #f1f5f9; /* Slate-100 */
        padding: 0.375rem;
        border-radius: 0.75rem;
        display: flex;
        overflow-x: auto;
      }

      .tab-button {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 0.5rem;
        color: #64748b; /* Slate-500 */
        transition: all 0.2s ease-in-out;
        white-space: nowrap;
      }

      .tab-button:hover {
        color: #334155; /* Slate-700 */
      }

      .tab-button.active {
        background-color: white;
        color: #4f46e5; /* Brand-600 */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      /* File Inputs */
      input[type="file"]::file-selector-button {
        background-color: #f8fafc;
        color: #475569;
        border: 1px solid #e2e8f0;
        padding: 0.3rem 0.8rem;
        border-radius: 0.375rem;
        margin-right: 1rem;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
      }
      input[type="file"]::file-selector-button:hover {
        background-color: #f1f5f9;
      }

      /* Loading */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body class="bg-slate-50 min-h-screen flex flex-col text-slate-900">
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
      <nav
        class="container mx-auto px-4 sm:px-6 h-16 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-sm"
          >
            <svg
              class="w-5 h-5 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              ></path>
            </svg>
          </div>
          <span class="text-xl font-bold text-slate-900 tracking-tight"
            >SellMize AI</span
          >
        </div>

        <div class="hidden md:flex items-center space-x-8">
          <a href="/" class="nav-item">Dashboard</a>
          <a
            href="/analyzer"
            class="text-brand-600 font-medium transition-colors"
            >Profit Analyzer</a
          >
          <a href="/strategist" class="nav-item">Strategist</a>
          <a href="/marketlens" class="nav-item">MarketLens</a>
          <a href="/content" class="nav-item">Content Gen</a>
        </div>
        <div class="flex items-center gap-4">
          {% if current_user.is_authenticated %}
          <div class="hidden sm:flex flex-col items-end mr-2">
            <span class="text-sm font-semibold text-slate-700"
              >{{ current_user.name or current_user.email }}</span
            >
            <a
              href="{{ url_for('auth.logout') }}"
              class="text-xs text-red-500 hover:text-red-700 font-medium transition-colors"
            >
              Sign out
            </a>
          </div>

          <div
            class="w-9 h-9 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-bold text-sm border border-brand-200 cursor-default"
          >
            {{ current_user.email[0].upper() }}
          </div>

          {% else %}
          <a
            href="{{ url_for('auth.login') }}"
            class="text-sm font-medium text-slate-600 hover:text-brand-600 transition-colors"
            >Log in</a
          >
          <a
            href="{{ url_for('auth.register') }}"
            class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm"
          >
            Get Started
          </a>
          {% endif %}
        </div>
        <!-- <div class="flex items-center gap-4">
          <button
            class="relative p-2 text-slate-400 hover:text-slate-600 transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
              ></path>
            </svg>
            <span
              class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white"
            ></span>
          </button>
          <div
            class="w-9 h-9 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-semibold text-sm border border-brand-200"
          >
            U
          </div>
        </div> -->
      </nav>

      <div
        id="mobileMenu"
        class="hidden md:hidden bg-white border-t border-slate-200 py-2"
      >
        <a href="/" class="block px-4 py-2 text-slate-600 hover:bg-slate-50"
          >Dashboard</a
        >
        <a
          href="/analyzer"
          class="block px-4 py-2 text-brand-600 bg-brand-50 font-medium"
          >Profit Analyzer</a
        >
        <a
          href="/strategist"
          class="block px-4 py-2 text-slate-600 hover:bg-slate-50"
          >Strategist</a
        >
        <a
          href="/marketlens"
          class="block px-4 py-2 text-slate-600 hover:bg-slate-50"
          >MarketLens</a
        >
        <a
          href="/content"
          class="block px-4 py-2 text-slate-600 hover:bg-slate-50"
          >Content Gen</a
        >
      </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-8 flex-grow">
      <div class="max-w-6xl mx-auto">
        <div
          id="uploadSection"
          class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-8"
        >
          <div class="mb-6 border-b border-slate-100 pb-4">
            <h1 class="text-2xl font-bold text-slate-900">
              E-commerce Profit Analyzer
            </h1>
            <p class="text-slate-500 mt-1 text-sm">
              Upload your Amazon reports to generate a consolidated P&L report.
            </p>
          </div>

          <form
            id="uploadForm"
            action="/analyze"
            method="POST"
            enctype="multipart/form-data"
            class="space-y-6"
          >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  for="order_files"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Order Files</label
                >
                <input
                  type="file"
                  name="order_files"
                  id="order_files"
                  multiple
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
              </div>
              <div>
                <label
                  for="payment_files"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Payment Files</label
                >
                <input
                  type="file"
                  name="payment_files"
                  id="payment_files"
                  multiple
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
              </div>
              <div>
                <label
                  for="return_files"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Return Files</label
                >
                <input
                  type="file"
                  name="return_files"
                  id="return_files"
                  multiple
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
              </div>
              <div>
                <label
                  for="cost_price_file"
                  class="block text-sm font-medium text-slate-700 mb-2"
                  >Cost Price File</label
                >
                <input
                  type="file"
                  name="cost_price_file"
                  id="cost_price_file"
                  required
                  class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 border border-slate-300 rounded-lg p-2 bg-slate-50 focus:outline-none focus:border-brand-500"
                />
              </div>
            </div>

            <div class="pt-6 border-t border-slate-200">
              <div class="flex items-center mb-4">
                <div class="p-1.5 bg-brand-100 rounded-md mr-2">
                  <svg
                    class="w-4 h-4 text-brand-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7V3m8 4V3m-9 8h10m-11 8h12a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                    ></path>
                  </svg>
                </div>
                <h3
                  class="text-sm font-semibold text-slate-900 uppercase tracking-wide"
                >
                  Date Range Filter
                </h3>
              </div>

              <div
                class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 p-5 rounded-lg border border-slate-200"
              >
                <div>
                  <label
                    for="start_date"
                    class="block text-xs font-medium text-slate-500 mb-1"
                    >Start Date</label
                  >
                  <input
                    type="date"
                    id="start_date"
                    name="start_date"
                    class="block w-full rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="end_date"
                    class="block text-xs font-medium text-slate-500 mb-1"
                    >End Date</label
                  >
                  <input
                    type="date"
                    id="end_date"
                    name="end_date"
                    class="block w-full rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm"
                  />
                </div>
              </div>
              <p class="text-xs text-slate-400 mt-2 italic">
                * Leave blank to analyze all data.
              </p>
            </div>

            <div class="pt-4 border-t border-slate-200">
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-semibold text-slate-900 uppercase tracking-wide"
                >
                  Business Expenses
                </h3>
                <button
                  type="button"
                  id="addExpenseBtn"
                  class="text-xs font-medium text-brand-600 hover:text-brand-800 bg-brand-50 px-3 py-1.5 rounded-md transition-colors"
                >
                  + Add Expense
                </button>
              </div>
              <div id="expenseContainer" class="space-y-3"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
              <button
                type="button"
                id="analyzeBtn"
                class="flex justify-center items-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-colors"
              >
                <span id="analyzeText">Analyze Data</span>
                <span
                  id="analyzeLoader"
                  class="loading ml-2"
                  style="display: none"
                ></span>
              </button>
              <button
                type="button"
                id="downloadBtn"
                disabled
                class="flex justify-center items-center py-2.5 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <span id="downloadText">Download Full Report</span>
                <span
                  id="downloadLoader"
                  class="loading ml-2 border-slate-400 border-t-slate-700"
                  style="display: none"
                ></span>
              </button>
            </div>
          </form>
        </div>

        <div
          id="summarySection"
          class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-8"
          style="display: none"
        >
          <h2 class="text-xl font-bold text-slate-900 mb-6">
            Profit Analysis Summary
          </h2>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            <div class="lg:col-span-2">
              <div
                id="dynamicExpenseCards"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
              >
                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Total Qty
                  </p>
                  <p
                    class="text-2xl font-bold text-slate-900 mt-1"
                    id="totalQuantity"
                  >
                    -
                  </p>
                </div>
                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Returned
                  </p>
                  <p
                    class="text-2xl font-bold text-red-600 mt-1"
                    id="totalReturned"
                  >
                    -
                  </p>
                </div>
                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Unpaid
                  </p>
                  <p
                    class="text-2xl font-bold text-amber-600 mt-1"
                    id="totalUnpaidOrders"
                  >
                    -
                  </p>
                </div>
                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Total Sales
                  </p>
                  <p
                    class="text-2xl font-bold text-emerald-600 mt-1"
                    id="totalPayment"
                  >
                    -
                  </p>
                </div>
                <div
                  class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"
                >
                  <p class="text-xs font-medium text-slate-500 uppercase">
                    Total Cost
                  </p>
                  <p
                    class="text-2xl font-bold text-slate-700 mt-1"
                    id="totalCost"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>

            <div class="lg:col-span-1 h-full">
              <div
                id="netProfitContainer"
                class="bg-slate-50 p-6 rounded-xl border border-slate-200 h-full flex flex-col justify-center items-center text-center"
              >
                <p
                  id="netProfitTitle"
                  class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-2"
                >
                  Net Profit
                </p>
                <p
                  class="text-4xl font-extrabold text-slate-900"
                  id="netProfit"
                >
                  -
                </p>
              </div>
            </div>
          </div>
        </div>

        <div
          id="tabSection"
          class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-8"
          style="display: none"
        >
          <div class="tab-container mb-6">
            <button id="ordersTab" class="tab-button active">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                ></path>
              </svg>
              Orders
            </button>
            <button id="statesTab" class="tab-button">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 3v18h18M3 9h18M3 15h18"
                ></path>
              </svg>
              States
            </button>
            <button id="returnsTab" class="tab-button">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
                ></path>
              </svg>
              Returns
            </button>
            <button id="unpaidTab" class="tab-button">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6 0a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Unpaid
            </button>
          </div>

          <div id="ordersContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center">
              Top 10 Best-Selling SKUs
            </h3>
            <div class="overflow-x-auto rounded-lg border border-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Rank
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      SKU
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Total Quantity
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="top10TableBody"
                  class="bg-white divide-y divide-slate-200"
                ></tbody>
              </table>
            </div>
          </div>

          <div id="statesContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
              Top 10 States by Order Quantity
            </h3>
            <div class="p-4 border border-slate-200 rounded-lg">
              <canvas id="stateOrdersChart" height="100"></canvas>
            </div>
          </div>

          <div id="returnsContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
              Top 10 Returned SKUs
            </h3>
            <div class="overflow-x-auto rounded-lg border border-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Rank
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      SKU
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Qty Returned
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Reason
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="top10ReturnsTableBody"
                  class="bg-white divide-y divide-slate-200"
                ></tbody>
              </table>
            </div>
          </div>

          <div id="unpaidContent" class="tab-content" style="display: none">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
              Orders Not Yet Paid
            </h3>
            <div class="overflow-x-auto rounded-lg border border-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Order ID
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      SKU
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Qty
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Price
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      Date
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"
                    >
                      State
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="unpaidTableBody"
                  class="bg-white divide-y divide-slate-200"
                ></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-white border-t border-slate-200 pt-12 pb-8">
      <div class="container mx-auto px-4 sm:px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
          <div>
            <div class="flex items-center gap-2 mb-4">
              <div
                class="w-6 h-6 bg-brand-600 rounded flex items-center justify-center"
              >
                <svg
                  class="w-3.5 h-3.5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  ></path>
                </svg>
              </div>
              <span class="font-bold text-slate-900">SellMize AI</span>
            </div>
            <p class="text-slate-500 text-sm">
              Empowering sellers with intelligent analytics.
            </p>
          </div>
          <div>
            <h4 class="font-semibold text-slate-900 mb-3 text-sm">Product</h4>
            <ul class="space-y-2 text-sm text-slate-500">
              <li><a href="#" class="hover:text-brand-600">Dashboard</a></li>
              <li><a href="#" class="hover:text-brand-600">Analytics</a></li>
              <li><a href="#" class="hover:text-brand-600">Reports</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold text-slate-900 mb-3 text-sm">Support</h4>
            <ul class="space-y-2 text-sm text-slate-500">
              <li><a href="#" class="hover:text-brand-600">Help Center</a></li>
              <li><a href="#" class="hover:text-brand-600">Contact</a></li>
              <li><a href="#" class="hover:text-brand-600">Status</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold text-slate-900 mb-3 text-sm">Legal</h4>
            <ul class="space-y-2 text-sm text-slate-500">
              <li><a href="#" class="hover:text-brand-600">Privacy</a></li>
              <li><a href="#" class="hover:text-brand-600">Terms</a></li>
            </ul>
          </div>
        </div>
        <div
          class="border-t border-slate-100 pt-6 text-center text-sm text-slate-400"
        >
          &copy; 2025 SellMize AI. All rights reserved.
        </div>
      </div>
    </footer>

    <div id="flash-container"></div>

    <script>
                  // Initialize Date Pickers
                  flatpickr("#start_date", { dateFormat: "Y-m-d", theme: "light", maxDate: "today" });
                  flatpickr("#end_date", { dateFormat: "Y-m-d", theme: "light", maxDate: "today" });

                  document.addEventListener("DOMContentLoaded", function () {
                      // --- Variable Initialization ---
                      let currentFileName = null;
                      let stateOrdersChart = null;
                      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
                      const mobileMenu = document.getElementById("mobileMenu");
                      const analyzeBtn = document.getElementById("analyzeBtn");
                      const downloadBtn = document.getElementById("downloadBtn");

                      // Tabs
                      const tabs = ['orders', 'returns', 'states', 'unpaid'];

                      // --- Helper Functions ---
                      function toggleMobileMenu() { mobileMenu.classList.toggle("hidden"); }

                      function showFlash(message, category) {
                          const flashDiv = document.createElement("div");
                          flashDiv.className = `flash ${category}`;
                          flashDiv.innerHTML = `<span>${message}</span>`;
                          const container = document.getElementById("flash-container");
                          container.appendChild(flashDiv);
                          setTimeout(() => {
                              flashDiv.classList.add("fade-out");
                              setTimeout(() => flashDiv.remove(), 300);
                          }, 4000);
                      }

                      function formatCurrency(value) {
                          return "₹" + parseFloat(value).toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                      }
                      function formatNumber(value) { return parseFloat(value).toLocaleString("en-IN"); }

                      function switchTabs(selectedTab) {
                          tabs.forEach(tab => {
                              document.getElementById(tab + 'Tab').classList.remove("active");
                              document.getElementById(tab + 'Content').style.display = "none";
                          });
                          document.getElementById(selectedTab + 'Tab').classList.add("active");
                          document.getElementById(selectedTab + 'Content').style.display = "block";
                      }

                      // --- Dynamic Expenses Logic ---
                      const expenseContainer = document.getElementById("expenseContainer");
                      const addExpenseBtn = document.getElementById("addExpenseBtn");
                      let expenseCount = 0;

                      function addExpenseRow(name = "", amount = "") {
                          expenseCount++;
                          const row = document.createElement("div");
                          row.className = "grid grid-cols-2 gap-4 items-center";
                          row.innerHTML = `
                              <input type="text" name="expense_name_${expenseCount}" placeholder="Expense Name" value="${name}" required
                                  class="rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm p-2 border">
                              <div class="flex items-center gap-2">
                                  <input type="number" name="expense_amount_${expenseCount}" placeholder="Amount" value="${amount}" step="0.01" required
                                      class="flex-1 rounded-md border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm p-2 border">
                                  <button type="button" class="remove-expense text-slate-400 hover:text-red-500 text-lg font-bold">×</button>
                              </div>`;
                          expenseContainer.appendChild(row);
                          row.querySelector(".remove-expense").addEventListener("click", () => row.remove());
                      }
                      addExpenseRow(); // Init default
                      addExpenseBtn.addEventListener("click", () => addExpenseRow());

                      // Pre-submit hook for expenses
                      document.getElementById("uploadForm").addEventListener("submit", () => {
                          const rows = expenseContainer.querySelectorAll("div.grid");
                          rows.forEach((row) => {
                              const nameInput = row.querySelector(`input[name^='expense_name_']`);
                              const amountInput = row.querySelector(`input[name^='expense_amount_']`);
                              const expenseName = nameInput.value.trim().toLowerCase().replace(/\s+/g, "_");
                              amountInput.name = `expense_${expenseName}`;
                              nameInput.removeAttribute("name");
                          });
                      });

                      // --- Event Listeners ---
                      if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener("click", toggleMobileMenu);
            }
                      downloadBtn.addEventListener("click", handleDownloadClick);
                      tabs.forEach(tab => document.getElementById(tab + 'Tab').addEventListener("click", () => switchTabs(tab)));
                      analyzeBtn.addEventListener("click", handleAnalyzeClick);

                      // --- Main Logic: Analyze Click ---
                      async function handleAnalyzeClick() {
                          const form = document.getElementById("uploadForm");
                          const formData = new FormData(form);

                          // Handle manual expenses for FormData
                          const rows = document.querySelectorAll("#expenseContainer div.grid");
                          rows.forEach((row) => {
                              const nameInput = row.querySelector(`input[name^='expense_name_']`);
                              const amountInput = row.querySelector(`input[name^='expense_amount_']`);
                              const expenseName = nameInput.value.trim().toLowerCase().replace(/\s+/g, "_");
                              const expenseAmount = amountInput.value;
                              // clean up raw inputs from form data and append correctly formatted one
                              formData.delete(nameInput.name);
                              formData.delete(amountInput.name);
                              if (expenseName && expenseAmount) formData.append(`expense_${expenseName}`, expenseAmount);
                          });

                          document.getElementById("analyzeText").textContent = "Analyzing...";
                          document.getElementById("analyzeLoader").style.display = "inline-block";
                          analyzeBtn.disabled = true;

                          try {
                              const response = await fetch("/analyze", { method: "POST", body: formData });
                              const raw = await response.text();
      console.log("RAW RESPONSE FROM BACKEND >>>", raw);

      let result;
      try {
          result = JSON.parse(raw);
      } catch (e) {
          showFlash("Backend returned invalid JSON. Check console.", "error");
          console.error("JSON parse failed. Raw backend data:", raw);
          return;
      }


                              if (result.success) {
                                  currentFileName = result.filename;

                                  // 1. Chart Logic (Theme Update)
                                  if (result.top_states && result.top_states.length > 0) {
                                      const ctx = document.getElementById("stateOrdersChart").getContext("2d");
                                      if (stateOrdersChart) stateOrdersChart.destroy();

                                      // INDIGO GRADIENT
                                      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                                      gradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
                                      gradient.addColorStop(1, 'rgba(79, 70, 229, 0.7)');

                                      stateOrdersChart = new Chart(ctx, {
                                          type: "bar",
                                          data: {
                                              labels: result.top_states.map(s => s.state),
                                              datasets: [{
                                                  label: "Orders",
                                                  data: result.top_states.map(s => s.total_orders),
                                                  backgroundColor: gradient,
                                                  borderRadius: 4,
                                                  barThickness: 30
                                              }]
                                          },
                                          options: {
                                              responsive: true,
                                              maintainAspectRatio: false,
                                              plugins: { legend: { display: false } },
                                              scales: {
                                                  x: { grid: { display: false }, ticks: { color: "#64748b" } },
                                                  y: { border: { display: false }, grid: { color: "#f1f5f9" }, ticks: { color: "#64748b" } }
                                              }
                                          }
                                      });
                                  }

                                  // 2. Summary Cards
                                  document.getElementById("totalQuantity").textContent = formatNumber(result.summary.total_quantity);
                                  document.getElementById("totalReturned").textContent = formatNumber(result.summary.total_return_quantity);
                                  document.getElementById("totalUnpaidOrders").textContent = formatNumber(result.summary.total_unpaid_orders);
                                  document.getElementById("totalPayment").textContent = formatCurrency(result.summary.total_payment);
                                  document.getElementById("totalCost").textContent = formatCurrency(result.summary.total_cost);

                                  // Net Profit Styling
                                  const netProfit = result.summary.net_profit;
                                  const profitText = document.getElementById("netProfit");
                                  const profitContainer = document.getElementById("netProfitContainer");
                                  profitText.textContent = formatCurrency(netProfit);

                                  profitContainer.className = netProfit < 0
                                      ? "bg-red-50 p-6 rounded-xl border border-red-200 h-full flex flex-col justify-center items-center text-center"
                                      : "bg-emerald-50 p-6 rounded-xl border border-emerald-200 h-full flex flex-col justify-center items-center text-center";

                                  profitText.className = netProfit < 0
                                      ? "text-4xl font-extrabold text-red-600"
                                      : "text-4xl font-extrabold text-emerald-600";

                                  // Dynamic Cards Injection
                                  const cardsContainer = document.getElementById("dynamicExpenseCards");
                                  document.querySelectorAll(".dynamic-expense-card").forEach(c => c.remove());

                                  const themeColors = [
                                      "bg-white border-slate-200 text-slate-900", // Neutral
                                      "bg-brand-50 border-brand-200 text-brand-900", // Indigo
                                  ];
                                  let cIndex = 0;

                                  Object.keys(result.summary).forEach(key => {
                                      if (key.startsWith("expense_")) {
                                          const label = key.replace("expense_", "").replace(/_/g, " ");
                                          const colorClass = themeColors[cIndex % themeColors.length];
                                          cIndex++;
                                          const card = document.createElement("div");
                                          card.className = `p-4 rounded-lg border shadow-sm dynamic-expense-card ${colorClass}`;
                                          card.innerHTML = `<p class="text-xs font-medium text-slate-500 uppercase">${label}</p>
                                                            <p class="text-2xl font-bold mt-1">${formatCurrency(result.summary[key])}</p>`;
                                          cardsContainer.appendChild(card);
                                      }
                                  });

                                  // 3. Populate Tables
                                  populateTable("top10TableBody", result.top_10_skus, [], 'orders');
                                  // Fix: Handle NaN explicitly in returns logic within populateTable
                                  populateTable("top10ReturnsTableBody", result.top_10_returns, [], 'returns');
                                  populateTable("unpaidTableBody", result.unpaid_orders, [], 'unpaid');

                                  // Show Sections
                                  document.getElementById("summarySection").style.display = "block";
                                  document.getElementById("tabSection").style.display = "block";
                                  switchTabs("orders");
                                  downloadBtn.disabled = false;
                                  showFlash("Analysis complete!", "success");
                                  document.getElementById("summarySection").scrollIntoView({ behavior: "smooth" });

                              } else {
                                  showFlash("Error: " + result.error, "error");
                              }
                          } catch (error) {
                              showFlash("Error: " + error.message, "error");
                          } finally {
                              document.getElementById("analyzeText").textContent = "Analyze Data";
                              document.getElementById("analyzeLoader").style.display = "none";
                              analyzeBtn.disabled = false;
                          }
                      }

                      // --- Generic Table Populator ---
                      function populateTable(elementId, data, columns, type) {
                          const tbody = document.getElementById(elementId);
                          tbody.innerHTML = "";
                          if (!data || data.length === 0) return;

                          data.forEach(item => {
                              const tr = document.createElement("tr");
                              tr.className = "hover:bg-slate-50 transition-colors";

                              if (type === 'orders') {
                                   tr.innerHTML = `
                                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${item.Rank}</td>
                                      <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item.sku}</td>
                                      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-brand-600">${formatNumber(item.quantity)}</td>`;
                              } else if (type === 'returns') {
                                  // Fix for NaN/Missing Category
                                  let category = item.return_category || item.category || 'N/A';
                                  // Convert to string to safely check for 'nan' string from python pandas
                                  if(String(category).toLowerCase() === 'nan' || category === null || category === undefined) {
                                      category = 'General Return';
                                  }

                                  tr.innerHTML = `
                                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${item.Rank}</td>
                                      <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${item.sku}</td>
                                      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">${formatNumber(item.quantity)}</td>
                                      <td class="px-6 py-4 whitespace-nowrap text-xs"><span class="px-2 py-1 bg-red-100 text-red-700 rounded-full">${category}</span></td>`;
                              } else if (type === 'unpaid') {
                                  tr.innerHTML = `
                                      <td class="px-6 py-4 text-sm text-slate-900">${item['Order ID']}</td>
                                      <td class="px-6 py-4 text-sm text-slate-500">${item.SKU}</td>
                                      <td class="px-6 py-4 text-sm text-slate-500">${item.Quantity}</td>
                                      <td class="px-6 py-4 text-sm text-slate-500">₹${item['Item Price']}</td>
                                      <td class="px-6 py-4 text-sm text-slate-500">${item['Order Date'] || '-'}</td>
                                      <td class="px-6 py-4 text-sm text-slate-500">${item['Ship State'] || '-'}</td>`;
                              } 
                              tbody.appendChild(tr);
                          });
                      }

                      async function handleDownloadClick() {
                          if (!currentFileName) return;
                          document.getElementById("downloadText").textContent = "Downloading...";
                          document.getElementById("downloadLoader").style.display = "inline-block";
                          downloadBtn.disabled = true;
                          try {
                              const response = await fetch("/download/" + currentFileName);
                              if (response.ok) {
                                  const blob = await response.blob();
                                  const url = window.URL.createObjectURL(blob);
                                  const a = document.createElement("a");
                                  a.href = url; a.download = currentFileName;
                                  document.body.appendChild(a); a.click();
                                  window.URL.revokeObjectURL(url); document.body.removeChild(a);
                              }
                          } catch(e) { showFlash("Download failed", "error"); }
                          finally {
                             document.getElementById("downloadText").textContent = "Download Full Report";
                             document.getElementById("downloadLoader").style.display = "none";
                             downloadBtn.disabled = false;
                          }
                      }

                      // --- Session Restore Logic (Preserved) ---
                      const isReload = performance.getEntriesByType("navigation")[0]?.type === "reload";
                      const savedDataExists = {{ 'true' if data_exists else 'false' }};

                      if (isReload) {
                          if(document.getElementById("uploadSection")) document.getElementById("uploadSection").style.display = "block";
                          fetch('/reset_analysis');
                      } else if (savedDataExists) {
                          try {
                              const savedSummary = {{ summary | tojson | safe }};
                              // Restore UI State using the data passed from Flask
                              if(document.getElementById("uploadSection")) document.getElementById("uploadSection").style.display = "none";

                              // Restore Expenses Inputs
                              const savedExpenses = {{ expenses | tojson | safe }};
                              if (savedExpenses) {
                                  expenseContainer.innerHTML = "";
                                  Object.entries(savedExpenses).forEach(([k,v]) => addExpenseRow(k, v));
                              }

                              // Restore Summary & Charts (Re-using logic by simulating a result object)
                              const mockResult = {
                                  success: true,
                                  summary: savedSummary,
                                  top_states: {{ top_states | tojson | safe }},
                                  top_10_skus: {{ top_10_skus | tojson | safe }},
                                  top_10_returns: {{ top_10_returns | tojson | safe }},
                                  unpaid_orders: {{ unpaid_orders | tojson | safe }}
                              };

                              // 1. Charts
                               if (mockResult.top_states) {
                                      const ctx = document.getElementById("stateOrdersChart").getContext("2d");
                                      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                                      gradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
                                      gradient.addColorStop(1, 'rgba(79, 70, 229, 0.7)');
                                      stateOrdersChart = new Chart(ctx, {
                                          type: "bar",
                                          data: {
                                              labels: mockResult.top_states.map(s => s.state),
                                              datasets: [{ label: "Orders", data: mockResult.top_states.map(s => s.total_orders), backgroundColor: gradient, borderRadius: 4, barThickness: 30 }]
                                          },
                                          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: {grid:{display:false}}, y: {border:{display:false}} } }
                                      });
                               }

                               // 2. Text Data
                               document.getElementById("totalQuantity").textContent = formatNumber(mockResult.summary.total_quantity);
                               document.getElementById("totalReturned").textContent = formatNumber(mockResult.summary.total_return_quantity);
                               document.getElementById("totalUnpaidOrders").textContent = formatNumber(mockResult.summary.total_unpaid_orders);
                               document.getElementById("totalPayment").textContent = formatCurrency(mockResult.summary.total_payment);
                               document.getElementById("totalCost").textContent = formatCurrency(mockResult.summary.total_cost);
                               document.getElementById("netProfit").textContent = formatCurrency(mockResult.summary.net_profit);

                               // 3. Tables
                               populateTable("top10TableBody", mockResult.top_10_skus, [], 'orders');
                               populateTable("top10ReturnsTableBody", mockResult.top_10_returns, [], 'returns');
                               populateTable("unpaidTableBody", mockResult.unpaid_orders, [], 'unpaid');

                               document.getElementById("summarySection").style.display = "block";
                               document.getElementById("tabSection").style.display = "block";
                               switchTabs("orders");
                               downloadBtn.disabled = false;
                               currentFileName = "{{ session.get('output_filename', '') }}";

                          } catch(e) { console.error("Restore failed", e); }
                      }
                  });
    </script>
  </body>
</html>
