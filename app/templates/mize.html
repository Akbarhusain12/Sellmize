<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mize - SellMize AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "sans-serif"] },
            colors: {
              brand: {
                50: "#eef2ff",
                100: "#e0e7ff",
                200: "#c7d2fe",
                300: "#a5b4fc",
                400: "#818cf8",
                500: "#6366f1",
                600: "#4f46e5",
                700: "#4338ca",
                800: "#3730a3",
              },
            },
          },
        },
      };
    </script>

    <style>
      /* --- Base Layout --- */
      body,
      html {
        height: 100%;
        overflow: hidden;
        font-family: "Inter", sans-serif;
      }

      /* --- Scrollbars --- */
      .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* --- Animations --- */
      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message-animate {
        animation: messageSlide 0.3s ease-out forwards;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 0.4;
          transform: scale(0.8);
        }
        50% {
          opacity: 1;
          transform: scale(1.1);
        }
      }
      .dot {
        animation: pulse-dot 1.2s infinite ease-in-out both;
      }
      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      /* --- Components --- */
      .nav-item {
        position: relative;
        color: #64748b;
        font-weight: 500;
        transition: color 0.2s;
      }
      .nav-item:hover,
      .nav-item.active {
        color: #4f46e5;
      }

      .sidebar-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: #475569;
        transition: all 0.2s;
        cursor: pointer;
      }
      .sidebar-link:hover {
        background-color: #f1f5f9;
        color: #1e293b;
      }
      .sidebar-link.active {
        background-color: #eef2ff;
        color: #4f46e5;
        font-weight: 500;
      }

      .chip {
        transition: all 0.2s;
        cursor: pointer;
        border: 1px solid #e2e8f0;
      }
      .chip:hover {
        background-color: #f8fafc;
      }
      .chip.active {
        background-color: #4f46e5;
        border-color: #4f46e5;
        color: white;
        box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25);
      }

      .prose-custom p {
        margin-bottom: 0.5rem;
        line-height: 1.6;
      }
      .prose-custom ul {
        list-style-type: disc;
        padding-left: 1.25rem;
        margin-bottom: 0.5rem;
      }
      .prose-custom strong {
        font-weight: 700;
        color: #334155;
      }
    </style>
  </head>

  <body class="bg-slate-50 flex flex-col h-screen w-full">
    <header
      class="bg-white border-b border-slate-200 sticky top-0 z-50 shrink-0 h-16"
    >
      <nav
        class="container mx-auto px-4 sm:px-6 h-full flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-sm"
          >
            <svg
              class="w-5 h-5 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              ></path>
            </svg>
          </div>
          <span class="text-xl font-bold text-slate-900 tracking-tight"
            >SellMize AI</span
          >
        </div>

        <div class="hidden md:flex items-center space-x-8">
          <a href="/" class="nav-item">Dashboard</a>
          <a href="/analyzer" class="nav-item">Profit Analyzer</a>
          <a href="/strategist" class="nav-item">Strategist</a>
          <a href="/mize" class="text-brand-600 font-medium transition-colors"
            >Mize</a
          >
        </div>

        <div class="flex items-center gap-4">
          {% if current_user.is_authenticated %}
          <div class="hidden sm:flex flex-col items-end mr-2">
            <span class="text-sm font-semibold text-slate-700"
              >{{ current_user.name or current_user.email }}</span
            >
            <a
              href="{{ url_for('auth.logout') }}"
              class="text-xs text-red-500 hover:text-red-700 font-medium"
              >Sign out</a
            >
          </div>
          <div
            class="w-9 h-9 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center font-bold text-sm border border-brand-200"
          >
            {{ current_user.email[0].upper() }}
          </div>
          {% else %}
          <a
            href="{{ url_for('auth.login') }}"
            class="text-sm font-medium text-slate-600"
            >Log in</a
          >
          <a
            href="{{ url_for('auth.register') }}"
            class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg shadow-sm"
            >Get Started</a
          >
          {% endif %}
        </div>
      </nav>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
      <aside
        id="sidebar"
        class="w-64 bg-slate-50 border-r border-slate-200 flex flex-col hidden md:flex transition-all duration-300 absolute md:relative z-20 h-full"
      >
        <div class="p-4 pt-6">
          <button
            onclick="startNewChat()"
            class="w-full flex items-center gap-2 justify-center bg-white border border-slate-200 hover:border-brand-300 hover:text-brand-600 hover:shadow-sm text-slate-600 font-medium py-2.5 px-4 rounded-xl transition-all text-sm"
          >
            <i class="ph-bold ph-plus"></i> New Chat
          </button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar px-3 space-y-6">
          <div>
            <h4
              class="px-2 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2"
            >
              Your Chats
            </h4>
            <div id="history-list" class="space-y-1"></div>
          </div>
        </div>
      </aside>

      <div
        id="mobile-overlay"
        onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-900/50 z-10 hidden md:hidden glass mt-16"
      ></div>

      <main class="flex-1 flex flex-col h-full relative bg-white min-w-0">
        <div
          class="md:hidden h-12 border-b border-slate-100 flex items-center px-4 bg-white shrink-0 justify-between"
        >
          <div class="flex items-center gap-3">
            <button
              onclick="toggleSidebar()"
              class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg"
            >
              <i class="ph-bold ph-list text-lg"></i>
            </button>
            <span class="text-sm font-semibold text-slate-700">Mize Chat</span>
          </div>
          <button onclick="startNewChat()" class="text-slate-400">
            <i class="ph-bold ph-eraser"></i>
          </button>
        </div>

        <div
          id="chat-messages"
          class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 space-y-6 scroll-smooth"
        >
          <div
            id="welcome-screen"
            class="h-full flex flex-col items-center justify-center pb-20 fade-in"
          >
            <div
              class="w-16 h-16 bg-white border border-slate-100 rounded-2xl flex items-center justify-center mb-6 shadow-xl shadow-slate-200/50"
            >
              <i class="ph-duotone ph-sparkle text-3xl text-brand-600"></i>
            </div>
            <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">
              How can I help you grow?
            </h2>
            <p
              class="text-slate-500 text-sm md:text-base mb-8 max-w-md text-center"
            >
              Your specialized AI partner for market intelligence and listing
              optimization.
            </p>

            <div
              class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-xl px-4"
            >
              <button
                onclick="setMode('product')"
                class="text-left p-4 rounded-xl border border-slate-200 hover:border-brand-400 hover:shadow-md transition-all group bg-white"
              >
                <div class="flex items-center gap-3 mb-2">
                  <div
                    class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors"
                  >
                    <i class="ph-bold ph-shopping-cart"></i>
                  </div>
                  <span class="font-semibold text-slate-800 text-sm"
                    >Product Scout</span
                  >
                </div>
                <p class="text-xs text-slate-500">
                  Find products under specific price.
                </p>
              </button>
              <button
                onclick="setMode('content')"
                class="text-left p-4 rounded-xl border border-slate-200 hover:border-brand-400 hover:shadow-md transition-all group bg-white"
              >
                <div class="flex items-center gap-3 mb-2">
                  <div
                    class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-colors"
                  >
                    <i class="ph-bold ph-pen-nib"></i>
                  </div>
                  <span class="font-semibold text-slate-800 text-sm"
                    >Listing Gen</span
                  >
                </div>
                <p class="text-xs text-slate-500">
                  Create SEO titles & bullet points.
                </p>
              </button>
            </div>
          </div>
        </div>

        <div
          class="p-4 bg-white/80 backdrop-blur-md border-t border-slate-100 z-10"
        >
          <div class="max-w-3xl mx-auto w-full">
            <div
              class="flex gap-2 mb-3 overflow-x-auto no-scrollbar py-1 justify-center md:justify-start"
            >
              <button
                onclick="setMode('auto')"
                id="mode-auto"
                class="chip active px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1.5 whitespace-nowrap"
              >
                <i class="ph-fill ph-magic-wand"></i> Auto
              </button>
              <button
                onclick="setMode('research')"
                id="mode-research"
                class="chip px-3 py-1.5 rounded-full text-xs font-semibold bg-white flex items-center gap-1.5 whitespace-nowrap"
              >
                <i class="ph-fill ph-globe"></i> Research
              </button>
              <button
                onclick="setMode('product')"
                id="mode-product"
                class="chip px-3 py-1.5 rounded-full text-xs font-semibold bg-white flex items-center gap-1.5 whitespace-nowrap"
              >
                <i class="ph-fill ph-shopping-cart"></i> Products
              </button>
              <button
                onclick="setMode('content')"
                id="mode-content"
                class="chip px-3 py-1.5 rounded-full text-xs font-semibold bg-white flex items-center gap-1.5 whitespace-nowrap"
              >
                <i class="ph-fill ph-pen-nib"></i> Content
              </button>
            </div>

            <div
              class="relative bg-slate-50 border border-slate-200 rounded-2xl shadow-sm focus-within:shadow-md focus-within:border-brand-400 focus-within:bg-white transition-all"
            >
              <textarea
                id="user-input"
                rows="1"
                class="w-full bg-transparent p-3.5 pr-12 text-sm text-slate-800 placeholder:text-slate-400 focus:outline-none resize-none max-h-40"
                placeholder="Ask Mize anything..."
                oninput="
                  this.style.height = '';
                  this.style.height = this.scrollHeight + 'px';
                "
              ></textarea>
              <button
                onclick="handleSend()"
                class="absolute right-2 bottom-2 p-2 bg-brand-600 text-white rounded-xl hover:bg-brand-700 transition-all shadow-sm active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <i class="ph-bold ph-paper-plane-right"></i>
              </button>
            </div>

            <p class="text-[10px] text-center text-slate-400 mt-2">
              AI can make mistakes. Please verify important info.
            </p>
          </div>
        </div>
      </main>
    </div>

    <script>
      let currentMode = "auto";
      let currentSessionId = null;

      document.addEventListener("DOMContentLoaded", () => {
        loadHistory();
      });

      // --- SESSION & HISTORY ---
      async function startNewChat() {
        try {
          const res = await fetch("/api/mize/session/new", { method: "POST" });
          const data = await res.json();
          if (data.success) {
            currentSessionId = data.session_id;
            clearChatUI();
            loadHistory();
          }
        } catch (e) {
          console.error("Failed to create session", e);
        }
      }

      async function loadSession(id) {
        currentSessionId = id;
        try {
          const res = await fetch(`/api/mize/session/${id}`);
          const data = await res.json();

          if (data.success) {
            const container = document.getElementById("chat-messages");
            const welcome = document.getElementById("welcome-screen");
            welcome.style.display = "none";
            container.innerHTML = "";

            data.messages.forEach((msg) => {
              if (msg.meta_data) {
                renderAIResponse(msg.meta_data);
              } else {
                appendMessage(msg.sender, msg.content);
              }
            });
          }
        } catch (e) {
          console.error("Failed to load session", e);
        }
      }

      async function loadHistory() {
        try {
          const res = await fetch("/api/mize/history");
          const data = await res.json();
          if (data.success) {
            const list = document.getElementById("history-list");
            if (!list) return;
            list.innerHTML = "";

            data.history.forEach((chat) => {
              const item = document.createElement("div");
              item.className = "sidebar-link";
              if (chat.id === currentSessionId) item.classList.add("active");
              item.innerHTML = `<i class="ph-regular ph-chat-circle-dots"></i><span class="truncate">${chat.title}</span>`;
              item.onclick = () => loadSession(chat.id);
              list.appendChild(item);
            });
          }
        } catch (e) {
          console.error("Failed to load history", e);
        }
      }

      // --- MESSAGING ---
      async function handleSend() {
        const input = document.getElementById("user-input");
        const text = input.value.trim();
        if (!text) return;

        if (!currentSessionId) {
          await startNewChat();
        }

        document.getElementById("welcome-screen").style.display = "none";
        appendMessage("user", text);
        input.value = "";

        const loadingId = appendLoading();

        try {
          const response = await fetch("/api/mize/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query: text,
              mode: currentMode,
              session_id: currentSessionId,
            }),
          });

          const data = await response.json();
          removeMessage(loadingId);

          if (data.success) {
            renderAIResponse(data.result);
            loadHistory();
          } else {
            appendMessage(
              "ai",
              `**Error:** ${data.error || "Something went wrong."}`,
            );
          }
        } catch (error) {
          removeMessage(loadingId);
          appendMessage("ai", "**Network Error:** Could not reach server.");
        }
      }

      // --- RENDERING ---
      function renderAIResponse(result) {
        const type = result.type;
        let htmlContent = "";

        if (type === "product" && result.products) {
          // Product Cards
          htmlContent += `<div class="mb-4 text-slate-700">${marked.parse(result.content || "")}</div>`;
          htmlContent += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">`;
          result.products.forEach((p) => {
            htmlContent += `
              <div class="bg-white border border-slate-200 p-3 rounded-xl shadow-sm hover:shadow-md transition-all group cursor-pointer">
                <div class="flex justify-between items-start mb-1">
                  <h4 class="font-bold text-slate-800 text-sm line-clamp-2 group-hover:text-brand-600 transition-colors">${p.name}</h4>
                </div>
                <div class="flex items-center justify-between mt-2">
                    <span class="bg-slate-100 text-slate-700 text-xs px-2 py-1 rounded-md font-bold">${p.currency || "â‚¹"} ${p.price}</span>
                    <div class="flex items-center text-xs text-yellow-500 font-medium"><i class="ph-fill ph-star mr-1"></i>${p.rating || "4.0"}</div>
                </div>
              </div>`;
          });
          htmlContent += `</div>`;
          appendRawHtml("ai", htmlContent);
        } else if (type === "content" && typeof result.content === "object") {
          // FIXED: Full Listing Display
          const data = result.content;
          htmlContent = `
             <div class="space-y-4 w-full">
               <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                  <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Title</p>
                  <p class="font-bold text-slate-900 text-sm">${data.title}</p>
               </div>
               <div>
                  <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Bullet Points</p>
                  <ul class="space-y-2">
                    ${data.bullet_points.map((bp) => `<li class="text-sm bg-white p-3 rounded-lg border border-slate-100 shadow-sm text-slate-700 leading-relaxed flex gap-2"><i class="ph-fill ph-check-circle text-brand-500 mt-1 shrink-0"></i><span>${bp}</span></li>`).join("")}
                  </ul>
               </div>
               <div class="bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                  <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Description</p>
                  ${data.description}
               </div>
             </div>
           `;
          appendRawHtml("ai", htmlContent);
        } else {
          // Standard Text
          const content =
            typeof result.content === "string"
              ? result.content
              : JSON.stringify(result.content);
          appendMessage("ai", content);
        }
      }

      function appendMessage(sender, content) {
        const html = marked.parse(content);
        appendRawHtml(sender, html);
      }

      function appendRawHtml(sender, html) {
        const container = document.getElementById("chat-messages");
        const msgDiv = document.createElement("div");
        msgDiv.className = `flex ${sender === "user" ? "justify-end" : "justify-start"} w-full message-animate`;

        const bubbleClass =
          sender === "user"
            ? "bg-brand-600 text-white rounded-2xl rounded-tr-sm shadow-md"
            : "bg-white border border-slate-200 text-slate-700 rounded-2xl rounded-tl-sm shadow-sm";
        const avatar =
          sender === "user"
            ? `<div class="w-8 h-8 rounded-lg bg-brand-50 border border-brand-100 flex items-center justify-center text-brand-600 font-bold text-xs shrink-0">ME</div>`
            : `<div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white shrink-0 shadow-lg shadow-indigo-200"><i class="ph-duotone ph-sparkle text-lg"></i></div>`;

        msgDiv.innerHTML = `
          <div class="flex items-end gap-3 max-w-[95%] md:max-w-[85%] ${sender === "user" ? "flex-row-reverse" : "flex-row"}">
            ${avatar}
            <div class="${bubbleClass} p-4 text-sm prose-custom overflow-hidden w-full">
              ${html}
            </div>
          </div>
        `;
        container.appendChild(msgDiv);
        container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });
      }

      function appendLoading() {
        const container = document.getElementById("chat-messages");
        const msgDiv = document.createElement("div");
        const id = "loading-" + Date.now();
        msgDiv.id = id;
        msgDiv.className = `flex justify-start w-full message-animate`;
        msgDiv.innerHTML = `<div class="flex items-end gap-3"><div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white shrink-0 shadow-md"><i class="ph-duotone ph-sparkle text-lg"></i></div><div class="bg-white border border-slate-200 text-slate-500 rounded-2xl rounded-tl-sm shadow-sm p-4 flex gap-1 items-center"><div class="w-2 h-2 bg-slate-400 rounded-full dot"></div><div class="w-2 h-2 bg-slate-400 rounded-full dot"></div><div class="w-2 h-2 bg-slate-400 rounded-full dot"></div></div></div>`;
        container.appendChild(msgDiv);
        container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });
        return id;
      }

      function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }
      function clearChatUI() {
        const container = document.getElementById("chat-messages");
        const welcome = document.getElementById("welcome-screen");
        container.innerHTML = "";
        container.appendChild(welcome);
        welcome.style.display = "flex";
      }
      function setMode(mode) {
        currentMode = mode;
        document
          .querySelectorAll(".chip")
          .forEach((c) => c.classList.remove("active"));
        document.getElementById(`mode-${mode}`)?.classList.add("active");
        document.getElementById("user-input").focus();
      }
      function toggleSidebar() {
        const sb = document.getElementById("sidebar");
        const mo = document.getElementById("mobile-overlay");
        sb.classList.toggle("hidden");
        sb.classList.toggle("absolute");
        sb.classList.toggle("h-full");
        mo.classList.toggle("hidden");
      }

      document.getElementById("user-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });
    </script>
  </body>
</html>
