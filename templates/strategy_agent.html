<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strategy Coach - SellMize AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
              accent: {
                50: "#fdf4ff",
                100: "#fae8ff",
                200: "#f5d0fe",
                300: "#f0abfc",
                400: "#e879f9",
                500: "#d946ef",
                600: "#c026d3",
                700: "#a21caf",
                800: "#86198f",
                900: "#701a75",
              },
            },
            animation: {
              "fade-in-up": "fadeInUp 0.3s ease-out",
            },
            keyframes: {
              fadeInUp: {
                "0%": { opacity: "0", transform: "translateY(10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }

      /* Theme styles */
      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      }
      .nav-link {
        position: relative;
        transition: all 0.3s ease;
      }
      .nav-link::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #0ea5e9, #d946ef);
        transition: width 0.3s ease;
      }
      .nav-link:hover::after,
      .nav-link.active::after {
        width: 100%;
      }
      .gradient-bg {
        background: linear-gradient(
          135deg,
          #0ea5e9 0%,
          #7dd3fc 50%,
          #d946ef 100%
        );
      }

      /* Chat Specific Styles */
      .chat-height {
        height: calc(100vh - 80px);
      } /* Adjust based on header height */
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Markdown Styles inside Chat */
      .prose h1,
      .prose h2,
      .prose h3 {
        color: #1e293b;
        font-weight: 700;
        margin-top: 1em;
        margin-bottom: 0.5em;
        font-size: 1.1em;
      }
      .prose ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-bottom: 1em;
      }
      .prose p {
        margin-bottom: 0.8em;
        line-height: 1.6;
      }
      .prose strong {
        color: #0284c7;
        font-weight: 600;
      }

      /* Typing Animation */
      .typing-dot {
        animation: typing 1.4s infinite ease-in-out both;
      }
      .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 h-screen flex flex-col overflow-hidden">
    <!-- HEADER -->
    <header class="glass-effect sticky top-0 z-50 shadow-md">
      <nav class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo and Brand -->
          <div class="flex items-center space-x-3">
            <div class="gradient-bg p-2 rounded-lg">
              <svg
                class="w-8 h-8 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
            </div>
            <div>
              <h1
                class="text-2xl font-bold bg-gradient-to-r from-primary-600 to-accent-600 bg-clip-text text-transparent"
              >
                SellMize AI
              </h1>
              <p class="text-xs text-gray-500">AI Product Content Generator</p>
            </div>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-8">
            <a
              href="/"
              class="nav-link text-gray-700 hover:text-primary-600 font-medium py-2"
            >
              Dashboard
            </a>
            <a
              href="/analyzer"
              class="nav-link text-gray-700 hover:text-primary-600 font-medium py-2"
            >
              Profit Analyzer
            </a>

            <a
              href="/strategy_agent"
              class="nav-link text-gray-700 hover:text-primary-600 font-medium py-2 active text-primary-600"
              >Strategy Agent</a
            >
            <a
              href="/content-generator"
              class="nav-link text-gray-700 hover:text-primary-600 font-medium py-2"
            >
              Content Generator
            </a>
          </div>

          <!-- User Profile -->
          <div class="hidden md:flex items-center space-x-4">
            <div
              class="w-10 h-10 bg-gradient-to-br from-primary-500 to-accent-500 rounded-full flex items-center justify-center text-white font-semibold"
            >
              U
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <button
            id="mobileMenuBtn"
            class="md:hidden p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <svg
              class="w-6 h-6 text-gray-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Mobile Navigation -->
        <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4 space-y-2">
          <a
            href="/"
            class="block px-4 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-lg transition-colors"
          >
            Dashboard
          </a>
          <a
            href="/analyzer"
            class="block px-4 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-lg transition-colors"
          >
            Profit Analyzer
          </a>
          <a
            href="/content-generator"
            class="block px-4 py-2 text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-lg transition-colors bg-primary-50 text-primary-600"
          >
            Content Generator
          </a>
        </div>
      </nav>
    </header>

    <!-- MAIN CHAT AREA -->
    <main
      class="flex-1 container mx-auto max-w-4xl px-4 py-6 flex flex-col h-full overflow-hidden"
    >
      <!-- Chat Container -->
      <div
        class="flex-1 bg-white rounded-2xl shadow-xl border border-gray-200 flex flex-col overflow-hidden"
      >
        <!-- Chat Header -->
        <div
          class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center"
        >
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center text-white font-bold shadow-md"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                ></path>
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-bold text-gray-800">AI Strategy Coach</h2>
              <p class="text-xs text-green-600 flex items-center">
                <span
                  class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"
                ></span>
                Online & Ready
              </p>
            </div>
          </div>
          <!-- Optional: Reset Button -->
          <button
            onclick="window.location.reload()"
            class="text-gray-400 hover:text-gray-600 transition-colors"
            title="Reset Chat"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Messages Area -->
        <div
          id="chat-messages"
          class="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50/50 scroll-smooth"
        >
          <!-- Initial Welcome Message -->
          <div class="flex items-start animate-fade-in-up">
            <div
              class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center mr-3 text-xs font-bold text-white shadow-sm"
            >
              AI
            </div>
            <div
              class="bg-white border border-gray-100 p-5 rounded-2xl rounded-tl-none shadow-sm max-w-2xl"
            >
              <p class="text-gray-700 text-sm leading-relaxed">
                Hello! I am your AI Strategy Coach. I have access to the
                financial data you uploaded in the Profit Analyzer.
              </p>
              <p class="text-gray-700 text-sm mt-3 leading-relaxed">
                I can analyze your margins, identify "leaks" in your expenses,
                and suggest actionable strategies to increase profit.
              </p>

              <!-- Suggestion Chips -->
              <div class="mt-4 flex flex-wrap gap-2">
                <button
                  onclick="sendQuickAction('Generate my profit analysis report')"
                  class="px-3 py-1.5 bg-primary-50 text-primary-700 text-xs font-medium rounded-full hover:bg-primary-100 border border-primary-200 transition-colors"
                >
                  ðŸ“Š Generate Strategy Report
                </button>
                <button
                  onclick="sendQuickAction('Where am I losing money?')"
                  class="px-3 py-1.5 bg-primary-50 text-primary-700 text-xs font-medium rounded-full hover:bg-primary-100 border border-primary-200 transition-colors"
                >
                  ðŸ’¸ Identify Leaks
                </button>
                <button
                  onclick="sendQuickAction('How do I improve my margins?')"
                  class="px-3 py-1.5 bg-primary-50 text-primary-700 text-xs font-medium rounded-full hover:bg-primary-100 border border-primary-200 transition-colors"
                >
                  ðŸ“ˆ Improve Margins
                </button>
              </div>

              {% if not data_exists %}
              <div
                class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-md"
              >
                <div class="flex">
                  <div class="flex-shrink-0">
                    <svg
                      class="h-5 w-5 text-yellow-400"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <div class="ml-3">
                    <p class="text-xs text-yellow-700">
                      Data missing. Please run the
                      <a
                        href="/analyzer"
                        class="font-bold underline hover:text-yellow-800"
                        >Profit Analyzer</a
                      >
                      first.
                    </p>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-100">
          <div class="relative flex items-center">
            <input
              type="text"
              id="user-input"
              class="w-full pl-4 pr-12 py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 focus:bg-white transition-all text-sm shadow-inner"
              placeholder="Ask me anything about your business metrics..."
              onkeypress="handleKeyPress(event)"
              {%
              if
              not
              data_exists
              %}disabled{%
              endif
              %}
            />
            <button
              id="send-btn"
              onclick="sendMessage()"
              class="absolute right-2 p-2 bg-gradient-to-r from-primary-600 to-accent-600 text-white rounded-lg shadow-md hover:shadow-lg hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              {%
              if
              not
              data_exists
              %}disabled{%
              endif
              %}
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                ></path>
              </svg>
            </button>
          </div>
          <p class="text-center text-[10px] text-gray-400 mt-2">
            AI generated insights. Verify critical financial data before taking
            action.
          </p>
        </div>
      </div>
    </main>

    <script>
      const chatMessages = document.getElementById('chat-messages');
      const userInput = document.getElementById('user-input');
      const sendBtn = document.getElementById('send-btn');
      let dataExists = {{ 'true' if data_exists else 'false' }};

      function handleKeyPress(e) {
        if (e.key === 'Enter' && !sendBtn.disabled) sendMessage();
      }

      function sendQuickAction(text) {
        if (!dataExists) return;
        userInput.value = text;
        sendMessage();
      }

      function appendMessage(sender, text, isHtml = false) {
        const div = document.createElement('div');
        div.className = `flex items-start ${sender === 'user' ? 'justify-end' : ''} animate-fade-in-up mb-4`;

        const bubbleStyle = sender === 'user'
          ? 'bg-gradient-to-br from-primary-600 to-accent-600 text-white rounded-2xl rounded-tr-none shadow-md'
          : 'bg-white border border-gray-100 text-gray-700 rounded-2xl rounded-tl-none shadow-sm';

        const avatar = sender === 'user'
          ? `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center ml-3 text-xs font-bold text-gray-600 shadow-sm">U</div>`
          : `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center mr-3 text-xs font-bold text-white shadow-sm">AI</div>`;

        // Process content (Markdown for AI, simple text for User)
        let contentHtml = isHtml ? text : `<p class="text-sm">${text}</p>`;

        div.innerHTML = sender === 'user'
          ? `<div class="${bubbleStyle} p-3 px-4 max-w-xl text-sm">${contentHtml}</div>${avatar}`
          : `${avatar}<div class="${bubbleStyle} p-5 max-w-2xl prose prose-sm prose-p:text-gray-600 prose-headings:text-gray-800">${contentHtml}</div>`;

        chatMessages.appendChild(div);

        // Smooth scroll to bottom
        setTimeout(() => {
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        }, 50);
      }

      function showTyping() {
        const id = 'typing-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = "flex items-start mb-4 animate-fade-in-up";
        div.innerHTML = `
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center mr-3 text-xs font-bold text-white shadow-sm">AI</div>
          <div class="bg-white border border-gray-100 p-4 rounded-2xl rounded-tl-none shadow-sm">
            <div class="flex space-x-1.5">
              <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
              <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
              <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
            </div>
          </div>
        `;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return id;
      }

      function removeTyping(id) {
        const el = document.getElementById(id);
        if(el) el.remove();
      }

      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // 1. User Message
        appendMessage('user', text);
        userInput.value = '';
        sendBtn.disabled = true; // Prevent double send

        // 2. Typing Indicator
        const typingId = showTyping();

        // 3. Backend Call
        try {
            // NOTE: Currently, the backend only supports "Generate Report" logic via this specific endpoint.
            // A truly conversational bot would need a more generic /chat endpoint.
            // For now, we map ANY input on this page to the strategy generator to demonstrate the capability.

            const response = await fetch('/api/strategy-coach', { method: 'POST' });
            const data = await response.json();

            removeTyping(typingId);

            if (data.success) {
                // Parse markdown
                const cleanHtml = marked.parse(data.report);
                appendMessage('ai', cleanHtml, true);
            } else {
                let errorMsg = data.error;
                if(data.error.includes("No financial data")) {
                   errorMsg = `I can't access your data right now. Please go to the <b>Profit Analyzer</b> and upload your files first.`;
                   dataExists = false;
                }
                appendMessage('ai', errorMsg, true);
            }
        } catch (err) {
            removeTyping(typingId);
            appendMessage('ai', "Sorry, I'm having trouble connecting to the server. Please try again.", true);
            console.error(err);
        } finally {
            sendBtn.disabled = false;
            userInput.focus();
        }
      }
    </script>
  </body>
</html>
